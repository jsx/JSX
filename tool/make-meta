#!/usr/bin/env perl
use 5.10.0;
use strict;
use warnings;
use Fatal qw(open close);

use File::Basename ();
use lib File::Basename::dirname(__FILE__) . "/../extlib/lib/perl5";

use version;
use JSON;

my($input_file, $output_file) = @ARGV;

my $json = do {
    open my $fh, "<", $input_file;
    local $/;
    <$fh>;
} or die "no files.\n";

my $meta = decode_json($json);

chmod 0666, $output_file if -e $output_file;

open my $fh, ">", $output_file;
print $fh <<'EOT';
// THIS FILE IS AUTOMATICALLY GENERATED.
// DO NOT EDIT IT DIRECTLY. EDIT tool/make-meta INSTEAD.

final class Meta {
EOT

say $fh sprintf '    static const VERSION_STRING   = "%s";',
    $meta->{version};
say $fh sprintf '    static const VERSION_NUMBER   =  %g;',
    qv($meta->{version})->numify();
say $fh sprintf '    static const LAST_COMMIT_HASH = "%s";',
    `git log -n 1 --pretty=format:%H`;
say $fh sprintf '    static const LAST_COMMIT_DATE = "%s";',
    `git log -n 1 --pretty=format:%ci`; # ISO-8601 style date

print $fh <<'EOT';

    static const IDENTIFIER = Meta.VERSION_STRING + " (" + Meta.LAST_COMMIT_DATE + "; " + Meta.LAST_COMMIT_HASH + ")";
} // class Meta
EOT


close $fh;
